<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
  <title>Al√¥, Calouro</title>
  <link rel="stylesheet" href="../style/style.css">
  <style>
    #chatContainer {
      padding: 20px;
      max-width: 600px;
      margin: 60px auto;
    }

    .info {
      margin-bottom: 10px;
    }

    #messages {
      background: white;
      padding: 15px;
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 5px;
    }

    .me {
      background-color: #d1e7dd;
      text-align: right;
    }

    .other {
      background-color: #ccc;
      text-align: left;
    }

    #messageForm {
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 8px;
    }

    button {
      padding: 8px 16px;
      background-color: #0A275C;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0e3475;
    }

    @media (max-width: 600px) {
      #chatContainer {
        margin-top: 20px;
      }

      form {
        flex-direction: column;
      }

      input,
      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <header class="header-inicio">
    <img src="../img/logo.png" alt="Logo" class="img-logo">

    <div class="nav-icons">
      <a href="/pages/home.html"><i class="uil uil-home"></i></a>
      <a href="/pages/post.html"><i class="uil uil-plus"></i></a>
      <a href="/pages/universal.html"><i class="uil uil-chat"></i></a>
      <a href="/pages/chat.html"><i class="uil uil-comment-alt-lock"></i></a>
      <a href="/pages/user.html"><i class="uil uil-user"></i></a>
    </div>
  </header>

  <div id="chatContainer">
    <div class="info" id="info">Carregando conversas...</div>
    <div id="messages"></div>

    <form id="messageForm" style="display: none;">
      <input type="text" id="messageInput" placeholder="Digite uma mensagem..." required />
      <button type="submit">Enviar</button>
    </form>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCqMQbzWlEs4zKMXt9wINzJxD0xhZcYIg",
      authDomain: "alocalouro.firebaseapp.com",
      projectId: "alocalouro",
      storageBucket: "alocalouro.appspot.com",
      messagingSenderId: "186368562877",
      appId: "1:186368562877:web:d0ef2bc2fd01d1188e89d4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const infoDiv = document.getElementById('info');
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');

    let currentUserId = null;
    let currentConversation = null;
    let currentOtherId = null;
    let currentOtherName = 'Usu√°rio';

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }

      currentUserId = user.uid;
      carregarConversas();
    });

    function carregarConversas() {
      messagesDiv.innerHTML = '';
      infoDiv.innerHTML = "<strong>Minhas conversas:</strong>";
      messageForm.style.display = 'none';

      db.ref('conversations').once('value', snapshot => {
        const conversations = snapshot.val() || {};

        for (let convKey in conversations) {
          if (convKey.includes(currentUserId)) {
            const parts = convKey.split('_');
            const otherId = parts.find(id => id !== currentUserId);

            db.ref('users/' + otherId + '/username').once('value').then(nameSnap => {
              const name = nameSnap.val() || 'Usu√°rio';

              const convoDiv = document.createElement('div');
              convoDiv.className = 'message other';
              convoDiv.style.cursor = 'pointer';

              // estilo para alinhar texto e bot√£o
              convoDiv.style.display = 'flex';
              convoDiv.style.justifyContent = 'space-between';
              convoDiv.style.alignItems = 'center';

              // conte√∫do da conversa
              const textSpan = document.createElement('span');
              textSpan.textContent = `üó®Ô∏è ${name}`;
              textSpan.style.flex = '1';
              convoDiv.appendChild(textSpan);

              convoDiv.onclick = () => {
                abrirConversa(convKey, otherId, name);
              };


              // bot√£o de exclus√£o
              const excluirBtn = document.createElement('button');
              excluirBtn.textContent = 'üóëÔ∏è';
              excluirBtn.style.background = '#dc3545';
              excluirBtn.style.color = 'white';
              excluirBtn.style.border = '1px solid #b02a37';
              excluirBtn.style.borderRadius = '6px';
              excluirBtn.style.cursor = 'pointer';
              excluirBtn.style.padding = '4px 10px';
              excluirBtn.style.marginLeft = '10px';

              // impede conflito de clique com abrirConversa
              excluirBtn.onclick = (e) => {
                e.stopPropagation();
                excluirConversa(convKey, name);
              };

              convoDiv.appendChild(excluirBtn);
              messagesDiv.appendChild(convoDiv);

            });
          }
        }

        if (messagesDiv.innerHTML === '') {
          messagesDiv.innerHTML = "<p>Nenhuma conversa encontrada.</p>";
        }
      });
    }

    function abrirConversa(conversationPath, otherId, otherName) {
      currentConversation = conversationPath;
      currentOtherId = otherId;
      currentOtherName = otherName;

      infoDiv.innerHTML = `<strong>Voc√™ est√° conversando com ${otherName}</strong>`;
      messagesDiv.innerHTML = '';
      messageForm.style.display = 'flex';

      const chatRef = db.ref('conversations/' + conversationPath + '/messages');
      chatRef.off();

      chatRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        const isMe = msg.senderId === currentUserId;

        const div = document.createElement('div');
        div.className = 'message ' + (isMe ? 'me' : 'other');
        div.textContent = `${isMe ? 'Voc√™' : otherName}: ${msg.text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    messageForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (text === '' || !currentConversation || !currentOtherId) return;

      const newMsg = {
        senderId: currentUserId,
        receiverId: currentOtherId,
        text,
        timestamp: Date.now()
      };

      db.ref('conversations/' + currentConversation + '/messages').push(newMsg)
        .then(() => messageInput.value = '')
        .catch(err => {
          alert("Erro ao enviar mensagem");
          console.error(err);
        });
    });

    function excluirConversa(conversationPath, otherName) {
      const confirmacao = confirm(`Tem certeza que deseja excluir a conversa com ${otherName}?`);

      if (confirmacao) {
        db.ref('conversations/' + conversationPath).remove()
          .then(() => {
            alert('Conversa exclu√≠da com sucesso.');
            currentConversation = null;
            currentOtherId = null;
            currentOtherName = 'Usu√°rio';
            carregarConversas();
          })
          .catch(err => {
            alert('Erro ao excluir conversa.');
            console.error(err);
          });
      }
    }
  </script>

</body>

</html>