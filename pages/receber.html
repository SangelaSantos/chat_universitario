<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Mensagens Recebidas</title>
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    #container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h2 {
      color: #0A275C;
    }

    .message {
      background: white;
      border-left: 5px solid #0A275C;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .message strong {
      display: block;
      margin-bottom: 5px;
    }

    .timestamp {
      font-size: 12px;
      color: gray;
      margin-top: 4px;
    }
  </style>
</head>

<body>

  <div id="container">
    <h2>Mensagens Recebidas</h2>
    <div id="messages">Carregando...</div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCqMQbzWlEs4zKMXt9wINzJxD0xhZcYIg",
      authDomain: "alocalouro.firebaseapp.com",
      projectId: "alocalouro",
      storageBucket: "alocalouro.appspot.com",
      messagingSenderId: "186368562877",
      appId: "1:186368562877:web:d0ef2bc2fd01d1188e89d4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const messagesDiv = document.getElementById('messages');

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }

      const currentUserId = user.uid;
      messagesDiv.innerHTML = "";

      // Escuta todas as conversas
      const convRef = db.ref('conversations');
      convRef.once('value', snapshot => {
        const convs = snapshot.val();

        if (!convs) {
          messagesDiv.innerHTML = "<p>Nenhuma mensagem encontrada.</p>";
          return;
        }

        let found = false;

        // Para cada conversa
        Object.entries(convs).forEach(([convId, convData]) => {
          if (convData.messages) {
            Object.entries(convData.messages).forEach(([msgId, msg]) => {
              if (msg.receiverId === currentUserId) {
                found = true;

                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.innerHTML = `
                  <strong>De: ${msg.senderId}</strong>
                  <p>${msg.text}</p>
                  <div class="timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                `;
                messagesDiv.appendChild(msgDiv);
              }
            });
          }
        });

        if (!found) {
          messagesDiv.innerHTML = "<p>Você ainda não recebeu mensagens.</p>";
        }
      });
    });
  </script>
</body>

</html>
